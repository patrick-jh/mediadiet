{% extends "base.html" %}
{% block content %}
<h2>Statistics</h2>
<div style="display:flex; flex-direction:column; gap:18px; margin-bottom:24px;">
    <!-- Charts row: full width -->
    <div style="display:flex; gap:18px; width:100%;">
        <div style="flex:1;">
            <h3 style="margin:0 0 8px 0;">Count of</h3>
            <div id="countsContainer" style="background:#fff; padding:12px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.06); min-height:160px; display:flex; align-items:center; justify-content:center;">
                <canvas id="chartCounts" height="150" style="width:100%; display:block;"></canvas>
                <div id="countsPlaceholder" style="display:none; color:#666;">No count data to display for the selected filters.</div>
            </div>
        </div>
        <div style="flex:1;">
            <h3 style="margin:0 0 8px 0;">Average Rating</h3>
            <div id="avgContainer" style="background:#fff; padding:12px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.06); min-height:160px; display:flex; align-items:center; justify-content:center;">
                <canvas id="chartAverages" height="150" style="width:100%; display:block;"></canvas>
                <div id="avgPlaceholder" style="display:none; color:#666;">No average rating data to display for the selected filters.</div>
            </div>
        </div>
    </div>

    <!-- Filters row: single-line controls -->
    <div style="display:flex; gap:8px; align-items:center; width:100%;">
        <form method="get" action="{{ url_for('statistics') }}" id="filtersRow" style="display:flex; gap:8px; align-items:center; width:100%; flex-wrap:nowrap;">
            <label style="display:flex; flex-direction:column; min-width:100px;">
                <span style="font-size:0.9em;">Media Type:</span>
                <select name="media_type" id="media_type" style="padding:4px; font-size:0.9em;">
                    <option value="" {% if not request.args.get('media_type') %}selected{% endif %}>All</option>
                    <option value="Book" {% if request.args.get('media_type') == 'Book' %}selected{% endif %}>Book</option>
                    <option value="Movie" {% if request.args.get('media_type') == 'Movie' %}selected{% endif %}>Movie</option>
                    <option value="Museum" {% if request.args.get('media_type') == 'Museum' %}selected{% endif %}>Museum</option>
                    <option value="Music" {% if request.args.get('media_type') == 'Music' %}selected{% endif %}>Music</option>
                    <option value="Podcast" {% if request.args.get('media_type') == 'Podcast' %}selected{% endif %}>Podcast</option>
                    <option value="Sports" {% if request.args.get('media_type') == 'Sports' %}selected{% endif %}>Sports</option>
                    <option value="TV" {% if request.args.get('media_type') == 'TV' %}selected{% endif %}>TV</option>
                </select>
            </label>

            <label style="display:flex; flex-direction:column; min-width:100px;">
                <span style="font-size:0.9em;">Genre:</span>
                <select name="genre" id="genre" style="padding:4px; font-size:0.9em;">
                    <option value="" {% if not request.args.get('genre') %}selected{% endif %}>All</option>
                    {% if request.args.get('media_type') and genre_map[request.args.get('media_type')] %}
                        {% for g in genre_map[request.args.get('media_type')] %}
                            <option value="{{ g }}" {% if request.args.get('genre') == g %}selected{% endif %}>{{ g }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </label>

            <label style="display:flex; flex-direction:column; min-width:80px;">
                <span style="font-size:0.9em;">Rating:</span>
                <select name="rating" id="rating" style="padding:4px; font-size:0.9em;">
                    <option value="" {% if not request.args.get('rating') %}selected{% endif %}>All</option>
                    <option value="5" {% if request.args.get('rating') == '5' %}selected{% endif %}>5</option>
                    <option value="4" {% if request.args.get('rating') == '4' %}selected{% endif %}>4</option>
                    <option value="3" {% if request.args.get('rating') == '3' %}selected{% endif %}>3</option>
                    <option value="2" {% if request.args.get('rating') == '2' %}selected{% endif %}>2</option>
                    <option value="1" {% if request.args.get('rating') == '1' %}selected{% endif %}>1</option>
                </select>
            </label>

            <label style="display:flex; flex-direction:column; min-width:90px;">
                <span style="font-size:0.9em;">Year Released:</span>
                <select name="year_released" id="year_released" style="padding:4px; font-size:0.9em;">
                    <option value="" {% if not request.args.get('year_released') %}selected{% endif %}>All</option>
                    {% for y in years %}
                        <option value="{{ y }}" {% if request.args.get('year_released') == y|string %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </label>

            <label style="display:flex; flex-direction:column; min-width:90px;">
                <span style="font-size:0.9em;">Year Consumed:</span>
                <select name="year_consumed" id="year_consumed" style="padding:4px; font-size:0.9em;">
                    <option value="" {% if not request.args.get('year_consumed') %}selected{% endif %}>All</option>
                    {% for yc in year_consumed_list %}
                        <option value="{{ yc }}" {% if request.args.get('year_consumed') == yc|string %}selected{% endif %}>{{ yc }}</option>
                    {% endfor %}
                </select>
            </label>

            <label style="display:flex; flex-direction:column; min-width:90px;">
                <span style="font-size:0.9em;">Source:</span>
                <select name="source" id="source" style="padding:4px; font-size:0.9em;">
                    <option value="" {% if not request.args.get('source') %}selected{% endif %}>All</option>
                    {% for s in sources %}
                        <option value="{{ s }}" {% if request.args.get('source') == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </label>

            <label style="display:flex; flex-direction:column; min-width:90px;">
                <span style="font-size:0.9em;">Recommended:</span>
                <select name="recommended" id="recommended" style="padding:4px; font-size:0.9em;">
                    <option value="" {% if not request.args.get('recommended') %}selected{% endif %}>All</option>
                    <option value="yes" {% if request.args.get('recommended') == 'yes' %}selected{% endif %}>Yes</option>
                </select>
            </label>

            <div style="display:flex; align-items:flex-end; padding-bottom:1px;">
                <input type="submit" value="Filter" style="padding:4px 12px; font-size:0.9em; margin-left:4px;">
            </div>
        </form>
    </div>
</div>

{% if posts %}
<table>
    <thead>
        <tr>
            <th>Year Consumed</th>
            <th>Title</th>
            <th>Type</th>
            <th>Genre</th>
            <th>Year Released</th>
            <th>Rating</th>
            <th>Recommended</th>
            <th>DNF</th>
        </tr>
    </thead>
    <tbody>
        {% for post in posts %}
        <tr>
            <td>{{ post.date.year if post.date else '' }}</td>
            <td>{{ post.title }}</td>
            <td>{{ post.media_type }}</td>
            <td>{{ post.genre }}</td>
            <td>{{ post.year_released }}</td>
            <td>{{ post.rating or "N/A" }}</td>
            <td>{{ "Yes" if post.recommended else "" }}</td>
            <td>{{ "Yes" if post.dnf else "" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div style="margin-top: 1em; display: flex; gap: 1em;">
    {% if pagination and pagination.has_prev %}
        <a href="{{ url_for('statistics', page=pagination.prev_num, media_type=request.args.get('media_type'), genre=request.args.get('genre'), rating=request.args.get('rating'), year_released=request.args.get('year_released'), source=request.args.get('source'), recommended=request.args.get('recommended')) }}">&laquo; Prev</a>
    {% endif %}
    {% if pagination %}
        <span>Page {{ pagination.page }} of {{ pagination.pages }}</span>
    {% endif %}
    {% if pagination and pagination.has_next %}
        <a href="{{ url_for('statistics', page=pagination.next_num, media_type=request.args.get('media_type'), genre=request.args.get('genre'), rating=request.args.get('rating'), year_released=request.args.get('year_released'), source=request.args.get('source'), recommended=request.args.get('recommended')) }}">Next &raquo;</a>
    {% endif %}
</div>
{% else %}
<p>No entries found.</p>
{% endif %}
<script>
    // Genre options for each media type
    const genreMap = {
        "Movie": ["Action/Thriller","Animated","Comedy","Documentary","Drama","Historical","Indie","Psychological","Romance","Scifi","Horror"],
        "Book": ["Comic","Crime","Fantasy","Historical Fiction","Horror","Literary","Mystery","Nonfiction","Scifi","Thriller"],
        "TV": ["Animated","Comedy","Documentary","Dramedy","Drama"],
        "Music": ["Classic Rock","Electronic","Folk","Indie","Jazz","Pop","Postrock","Rap","Rock","Country"],
        "Sports": ["Baseball", "Basketball", "Football", "Auto Racing", "Olympics", "Soccer", "Other"],
        "Podcast": ["Entertainment", "Commentary", "News"],
        "Museum": ["Art", "History", "Science", "Other"]
    };
    document.addEventListener('DOMContentLoaded', function() {
        const mediaTypeSelect = document.getElementById('media_type');
        const genreSelect = document.getElementById('genre');
        function updateGenreOptions() {
            const selected = mediaTypeSelect.value;
            genreSelect.innerHTML = '<option value="">All</option>';
            if (selected && genreMap[selected]) {
                genreMap[selected].forEach(function(genre) {
                    const opt = document.createElement('option');
                    opt.value = genre;
                    opt.textContent = genre;
                    genreSelect.appendChild(opt);
                });
            }
        }
        mediaTypeSelect.addEventListener('change', updateGenreOptions);
        updateGenreOptions(); // initial load
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    const topLabels = {{ (top_labels|default([]))|tojson|safe }};
    const topValues = {{ (top_values|default([]))|tojson|safe }};
    const bottomLabels = {{ (bottom_labels|default([]))|tojson|safe }};
    const bottomValues = {{ (bottom_values|default([]))|tojson|safe }};

    // Helper to show/hide placeholders when no data
    function toggleContainer(containerId, placeholderId, hasData) {
        const container = document.getElementById(containerId);
        const placeholder = document.getElementById(placeholderId);
        if (!hasData) {
            // hide canvas, show placeholder
            const canvas = container.querySelector('canvas');
            if (canvas) canvas.style.display = 'none';
            placeholder.style.display = 'block';
        } else {
            const canvas = container.querySelector('canvas');
            if (canvas) canvas.style.display = 'block';
            placeholder.style.display = 'none';
        }
    }

    // Counts chart (top)
    const countsHasData = Array.isArray(topValues) && topValues.length > 0;
    toggleContainer('countsContainer', 'countsPlaceholder', countsHasData);
    if (countsHasData) {
        const ctxCounts = document.getElementById('chartCounts').getContext('2d');
        new Chart(ctxCounts, {
            type: 'bar',
            data: {
                labels: topLabels,
                datasets: [{
                    label: 'Count',
                    data: topValues,
                    backgroundColor: topLabels.map((_, i) => `hsl(${(i*40) % 360} 70% 55% / 0.9)`),
                    borderColor: topLabels.map((_, i) => `hsl(${(i*40) % 360} 70% 40% / 1)`),
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y ?? context.parsed;
                                return `${label}: ${value}`;
                            }
                        }
                    },
                    legend: { display: false }
                },
                scales: { x: { ticks: { autoSkip: false } }, y: { beginAtZero: true } },
                maintainAspectRatio: false
            }
        });
    }

    // Average rating chart (bottom)
    const avgHasData = Array.isArray(bottomValues) && bottomValues.length > 0;
    toggleContainer('avgContainer', 'avgPlaceholder', avgHasData);
    if (avgHasData) {
        const ctxAvg = document.getElementById('chartAverages').getContext('2d');
        new Chart(ctxAvg, {
            type: 'bar',
            data: {
                labels: bottomLabels,
                datasets: [{
                    label: 'Average Rating',
                    data: bottomValues,
                    backgroundColor: bottomLabels.map((_, i) => `hsl(${(i*30) % 360} 80% 60% / 0.95)`),
                    borderColor: bottomLabels.map((_, i) => `hsl(${(i*30) % 360} 80% 45% / 1)`),
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                // ensure a nicely formatted number for averages
                                const value = context.parsed.y ?? context.parsed;
                                return `${label}: ${Number(value).toFixed(2)}`;
                            }
                        }
                    },
                    legend: { display: false }
                },
                scales: { x: { ticks: { autoSkip: false } }, y: { beginAtZero: true, suggestedMax: 5 } },
                maintainAspectRatio: false
            }
        });
    }
});
</script>
{% endblock %}
